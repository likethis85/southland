<div>
    <div style="float:left;border-bottom: #c3daf9 1px solid; border-left: #c3daf9 1px solid; width: 32%; height: 480px; overflow: auto; border-top: #c3daf9 1px solid; border-right: #c3daf9 1px solid;">
        <div id="tree" style="float:left;"></div>
    </div>
    <style type="text/css">
        .taskdetail { border-collapse:collapse;}
        .taskdetail h4 { margin:0px; padding:0px;}
        .taskdetail img { float:right;}
        .taskdetail ul { margin:10px 0 10px 40px; padding:0px;}
        .taskdetail th { background:#7CB8E2 url("/vendors/jexpand/header_bkg.png") repeat-x scroll center left; color:#fff; padding:7px 15px; text-align:left;}
        .taskdetail.odd td { background:#fff url("/vendors/jexpand/header_bkg.png") repeat-x scroll center left; cursor:pointer; }
        .taskdetail div.arrow { background:transparent url("/vendors/jexpand/arrows.png") no-repeat scroll 0px -16px; width:16px; height:16px; display:block;}
        .taskdetail div.up { background-position:0px 0px;}
    </style>
    <script type="text/javascript">  
    $().ready(function(){
            if ($.browser.msie) {  
                $("input:radio").click(function () {this.blur();this.focus();});
            }

            $(".taskdetail:odd").addClass("odd");
            //$("#taskdetail tr:not(.odd)").hide();
            //$("#taskdetail tr:first-child").show();
    
            $(".taskdetail.odd").click(function(){
                $(this).next("tr").toggle($(this).next("tr").css('display')=='none');
                $(this).find(".arrow").toggleClass("up");
            });

            $("#TaskPriority :radio").change(function () {
                $.ajax({
                    type:"get",
                    url: document.location.protocol+"//"+location.hostname+"/ajax.php",
                    data: "c=main&a=utp&id=<{$tCurrTask}>&val="+$(this).val(),
                    dataType: "text",
                    success: function(msg){
                        location.href = location.href;
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        location.href = location.href;
                    },
                });
            });

            $("#TaskStatus :radio").change(function () {
                $.ajax({
                    type:"get",
                    url: document.location.protocol+"//"+location.hostname+"/ajax.php",
                    data: "c=main&a=uts&id=<{$tCurrTask}>&val="+$(this).val(),
                    dataType: "text",
                    success: function(msg){
                        location.href = location.href;
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        location.href = location.href;
                    },
                });
            });

            $("#replyform").validate({
                rules:{
                    dsrte_text: {required:true}
                }
            });
    });
    </script>  
    <div style="margin-left:12px;float:left;width:64%">
        <{foreach item=item from=$tTasks}>
        <{if $item.id eq $tCurrTask}>
        <table width="100%">
            <thead style="display:none;">
                <tr class="taskdetail"><th></th></tr>
            </thead>
            <tbody>
                <tr class="taskdetail"><td><{$item.subject}></td></tr>
                <tr class="taskdetail">
                    <td><{$item.detail}></td>
                </tr>
                
                <tr class="taskdetail"><td><{T w="TaskPriority"}></td></tr>
                <tr class="taskdetail">
                    <td id="TaskPriority">
                    <input type="radio" name="priority" value="0" <{if $item.priority eq 0}> checked <{/if}>><{T w="Low"}>
                    <input type="radio" name="priority" value="1" <{if $item.priority eq 1}> checked <{/if}>><{T w="Medium"}>
                    <input type="radio" name="priority" value="2" <{if $item.priority gt 1}> checked <{/if}>><{T w="High"}>
                    </td>
                </tr>
                
                <tr class="taskdetail"><td><{T w="TaskStatus"}></td></tr>
                <tr class="taskdetail">
                    <td id="TaskStatus">
                    <input type="radio" name="status" value="0" <{if $item.status eq 0}> checked <{/if}>><{T w="TaskPending"}>
                    <input type="radio" name="status" value="1" <{if $item.status eq 1}> checked <{/if}>><{T w="TaskProcessing"}>
                    <input type="radio" name="status" value="2" <{if $item.status gt 1}> checked <{/if}>><{T w="TaskAccomplished"}>
                    </td>
                </tr>

                <tr class="taskdetail"><td><{T w="TaskComment"}></td></tr>
                <tr class="taskdetail"><td>
                    <{foreach item=item from=$tComments}>
                    <div style="border-bottom:solid grey 1px;">
                        <div><{$item.content}></div>
                        <div style="padding-bottom:2px;text-align:right;"><{$item.addtime}>&nbsp;--&nbsp;<{$item.user.firstname}>&nbsp;<{$item.user.lastname}></div>
                    </div>
                    <{/foreach}>
                    <div>
                        <form id="replyform" method="post" action="/task.php?a=cmt&id=<{$tCurrTask}>">
                            <div style="margin-top:32px;">
                                <input type=submit value="<{T w='Reply'}>">
                                <{$dsrte->getHTML("")}>
                            </div>
                            <input name="submitreply" type="hidden" id="submitreply" value="1">
                        </form>
                    </div>
                </td></tr>
            </tbody>
        </table>
        <{/if}>
        <{/foreach}>
    </div>
</div>
<script src="/vendors/wdtree/jquery.tree.js" type="text/javascript"></script>
<script type="text/javascript">
    function attachTo(parent, node) {
        if(node.pid==parent.id) {
            parent.hasChildren = true;
            node.parent = parent;
            parent.ChildNodes.push(node);
        } else {
            for(var i=0,n;n=parent.ChildNodes[i++],n!=null;){
                if(node.pid==n.id) {
                    n.hasChildren=true;
                    node.parent = n;
                    n.ChildNodes.push(node);
                    return;
                }
            }
            for(i=0,n;n=parent.ChildNodes[i++],n!=null;){
                attachTo(n,node);
            }
        }
    }


    var root = {
        "id" : "0",
        "pid" : "0",
        "text" : "Task",
        "value" : "86",
        "showcheck" : false,
        "complete" : true,
        "isexpand" : true,
        "checkstate" : 0,
        "hasChildren" : false,
        "ChildNodes" : [],
    };
    var items = [
        <{foreach item=item from=$tTasks}>
        {"id" :    "<{$item.id}>",
         "pid":    "<{$item.pid}>",
         "text" :  "<{$item.subject}>",
         "value" : "<{$item.subject}>",
         "showcheck" : false,
         "complete" : true,
         "isexpand" : false,
         "checkstate" : 0,
         "hasChildren" : false,
         "selected": <{if $item.id eq $tCurrTask}> true <{else}> false <{/if}>,
         "ChildNodes": [],
        },
        <{/foreach}>
    ];

    for(var i=0,n;n=items[i++],n!=null;)
        attachTo(root, n);

    var userAgent = window.navigator.userAgent.toLowerCase();
    $.browser.msie8 = $.browser.msie && /msie 8\.0/i.test(userAgent);
    $.browser.msie7 = $.browser.msie && /msie 7\.0/i.test(userAgent);
    $.browser.msie6 = !$.browser.msie8 && !$.browser.msie7 && $.browser.msie && /msie 6\.0/i.test(userAgent);
    function load() {        
        var o = {
            showcheck: false,
            onnodeclick: function(item) {
                location.href=self.location.href.replace(/\&id=\d+/,"")+"&id="+item.id;
            },
            onnodehoverIn : function(item) {
                var me = item.id.replace(/[^\w-]/gi, "_");
                var opDiv = $("<div id='tree_node_operator' style='float:right'></div>");
                opDiv.append("<a href=\"/task.php?c=main&a=add&id="+item.id+"\"><div title=\"<{T w='AddTask'}>\" style=\"float:left;background-image:url('/vendors/wdtree/add.png');background-position:-8px; width:16px; height:16px; margin-right:2px;\"></div></a>");
                opDiv.append("<a href=\"/task.php?c=main&a=del&id="+item.id+"\"><div title=\"<{T w='DelTask'}>\" style=\"float:left;background-image:url('/vendors/wdtree/sub.png');background-position:-8px; width:16px; height:16px; margin-right:2px;\"></div></a>");
                if(item.id != 0) {
                    opDiv.append("<a href=\"/task.php?c=main&a=update&id="+item.id+"\"><div title=\"<{T w='EditTask'}>\" style=\"float:left;background-image:url('/vendors/wdtree/edit.png');background-position:-8px; width:16px; height:16px;\"></div></a>");
                }
                $("#tree_"+me).append(opDiv);
            },
            onnodehoverOut : function(item) {
                $("#tree_node_operator").remove();
            }
        };
        o.data = [root];
        $("#tree").treeview(o);

        for(var i=0,n;n=items[i++],n!=null;) {
            if(n.selected == true) {
                var me = n.id.replace(/[^\w-]/gi, "_");
                while(p = n){
                    if(!p.isexpand) {
                        var nid = p.id.replace(/[^\w]/gi, "_");
                        var img = $("#tree_" + nid + " img.bbit-tree-ec-icon");
                        if (img.length > 0) 
                            img.click();
                    }
                    n = p.parent;
                }
                $("#tree_"+me).addClass("bbit-tree-selected");
                return;
            }
        }

    }
    if( $.browser.msie6) {
        load();
    }
    else{
        $(document).ready(load);
    }
</script>

